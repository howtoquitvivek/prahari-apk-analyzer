<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Prahari: APK Scan - Safeguarding Banking Applications</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        'sans': ['Inter', 'system-ui', 'sans-serif'],
                        'mono': ['JetBrains Mono', 'monospace'],
                    },
                    colors: {
                    'prahari-charleston-green': '#1E2A2F',        //dark-header
                    'prahari-gainsboro': '#D7DEDF',               //light-icon
                    'prahari-antiflashwhite': '#F4F2F1',
                    'prahari-lightred': '#FFCCCF',
                    'prahari-brightgrey': '#EAEFF4',
                    'prahari-aliceblue': '#F2F7FA'

                    }
                }
            }
        }
    </script>
    <style>
        .tooltip {
            visibility: hidden;
            opacity: 0;
            transition: opacity 0.3s;
        }
        .tooltip-trigger:hover .tooltip {
            visibility: visible;
            opacity: 1;
        }
        .progress-bar {
            background: linear-gradient(90deg, #A6B28B 0%, #F5C9B0 100%);
        }
        .risk-high { color: #DC2626; }
        .risk-medium { color: #F59E0B; }
        .risk-low { color: #059669; }
        .modal {
            display: none;
        }
        .modal.active {
            display: flex;
        }
        .loading-spinner {
            border: 2px solid #f3f4f6;
            border-top: 2px solid #A6B28B;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
            display: inline-block;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-prahari-brightgrey min-h-screen">
    <!-- Header -->
    <header class="bg-prahari-charleston-green text-white py-6 shadow-lg">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-3">
                    <!-- Mock Icon -->
                    <div class="w-12 h-12 bg-prahari-gainsboro rounded-lg flex items-center justify-center">
                        <svg class="w-8 h-8 text-prahari-charleston-green" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M2.166 4.999A11.954 11.954 0 0010 1.944 11.954 11.954 0 0017.834 5c.11.65.166 1.32.166 2.001 0 5.225-3.34 9.67-8 11.317C5.34 16.67 2 12.225 2 7c0-.682.057-1.35.166-2.001zm11.541 3.708a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path>
                        </svg>
                    </div>
                    <div>
                        <h1 class="text-2xl font-bold">Prahari: APK Scan</h1>
                        <p class="text-prahari-gainsboro text-sm">Safeguarding Banking Applications</p>
                    </div>
                </div>
                <div id="scanStats" class="flex space-x-6 text-sm">
                    <div class="text-center">
                        <div class="text-2xl font-bold text-prahari-brightgrey" id="totalScans">
                            <div class="loading-spinner"></div>
                        </div>
                        <div class="text-prahari-gainsboro">Total Scans</div>
                    </div>
                    <div class="text-center">
                        <div class="text-2xl font-bold text-red-400" id="highRiskScans">
                            <div class="loading-spinner"></div>
                        </div>
                        <div class="text-prahari-gainsboro">High Risk</div>
                    </div>
                    <div class="text-center">
                        <div class="text-2xl font-bold text-green-400" id="safeScans">
                            <div class="loading-spinner"></div>
                        </div>
                        <div class="text-prahari-gainsboro">Safe</div>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <!-- Upload Section -->
        <section id="uploadSection" class="bg-white rounded-xl shadow-lg p-8 mb-8">
            <div class="text-center">
                <h2 class="text-2xl font-bold text-prahari-charleston-green mb-4">Upload Banking APK for Analysis</h2>
                
                <!-- Upload Drop Zone -->
                <div id="dropZone" class="border-2 border-dashed border-prahari-gainsboro hover:border-prahari-charleston-green transition-colors duration-300 rounded-lg p-12 cursor-pointer">
                    <svg class="mx-auto h-16 w-16 text-prahari-gainsboro mb-4" stroke="currentColor" fill="none" viewBox="0 0 48 48">
                        <path d="M28 8H12a4 4 0 00-4 4v20m32-12v8m0 0v8a4 4 0 01-4 4H12a4 4 0 01-4-4v-4m32-4l-3.172-3.172a4 4 0 00-5.656 0L28 28M8 32l9.172-9.172a4 4 0 015.656 0L28 28m0 0l4 4m4-24h8m-4-4v8m-12 4h.02" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></path>
                    </svg>
                    <p class="text-lg text-prahari-charleston-green font-semibold mb-2">Drop your APK file here</p>
                    <p class="text-sm text-gray-600 mb-4">or click to browse files</p>
                    <button type="button" class="bg-prahari-charleston-green text-white px-6 py-2 rounded-lg hover:bg-opacity-90 transition-colors">
                        Choose File
                    </button>
                    <input type="file" id="fileInput" class="hidden" accept=".apk">
                </div>
                
                <!-- Selected File Display -->
                <div id="fileSelectedSection" class="hidden">
                    <div class="flex items-center justify-center p-8 bg-prahari-brightgrey rounded-lg border-2 border-prahari-gainsboro">
                        <div class="flex items-center space-x-4 flex-1">
                            <!-- APK Icon -->
                            <div class="w-16 h-16 bg-prahari-gainsboro rounded-lg flex items-center justify-center flex-shrink-0">
                                <svg class="w-8 h-8 text-prahari-charleston-green" fill="currentColor" viewBox="0 0 20 20">
                                    <path d="M4 3a2 2 0 00-2 2v1.5h12V5a2 2 0 00-2-2H4z"></path>
                                    <path fill-rule="evenodd" d="M2 9.5V17a2 2 0 002 2h8a2 2 0 002-2V9.5H2zm7.5 3.5a1.5 1.5 0 11-3 0 1.5 1.5 0 013 0z" clip-rule="evenodd"></path>
                                </svg>
                            </div>
                            
                            <!-- File Details -->
                            <div class="flex-1 text-left">
                                <h3 class="text-lg font-bold text-prahari-charleston-green" id="selectedFileName">app.apk</h3>
                                <div class="flex items-center space-x-4 mt-1">
                                    <span class="text-sm text-gray-600">
                                        <strong>Size:</strong> <span id="selectedFileSize">0 MB</span>
                                    </span>
                                    <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-green-100 text-green-800">
                                        Ready for Analysis
                                    </span>
                                </div>
                            </div>
                            
                            <!-- Remove Button -->
                            <button id="removeFileBtn" class="w-8 h-8 bg-red-500 text-white rounded-full hover:bg-red-600 transition-colors flex items-center justify-center flex-shrink-0" title="Remove file">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                </svg>
                            </button>
                        </div>
                    </div>
                    
                    <!-- Analyze Button -->
                    <button id="analyzeBtn" class="mt-6 bg-prahari-gainsboro text-prahari-charleston-green px-8 py-3 rounded-lg font-semibold hover:bg-opacity-80 transition-colors inline-flex items-center space-x-2">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                        <span>Start Analysis</span>
                    </button>
                </div>
            </div>
        </section>

        <!-- Progress Section -->
        <section id="progressSection" class="hidden bg-white rounded-xl shadow-lg p-8 mb-8">
            <div class="text-center">
                <h3 class="text-xl font-bold text-prahari-charleston-green mb-4">Analyzing APK...</h3>
                <div class="w-full bg-gray-200 rounded-full h-4 mb-4">
                    <div id="progressBar" class="progress-bar h-4 rounded-full transition-all duration-500" style="width: 0%"></div>
                </div>
                <p id="progressText" class="text-sm text-prahari-charleston-green">Initializing analysis...</p>
            </div>
        </section>

        <!-- Results Dashboard -->
        <section id="resultsSection" class="hidden bg-white rounded-xl shadow-lg p-8 mb-8">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-2xl font-bold text-prahari-charleston-green">Analysis Results</h3>
                <div class="flex space-x-3">
                    <button id="newScanBtn" class="bg-prahari-charleston-green text-white px-4 py-2 rounded-lg hover:bg-opacity-90 transition-colors">
                        New Scan
                    </button>
                    <button id="fullReportBtn" class="bg-prahari-gainsboro text-prahari-charleston-green px-4 py-2 rounded-lg hover:bg-opacity-80 transition-colors">
                        Full Report
                    </button>
                </div>
            </div>

            <div id="resultsContent" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                <!-- Results will be populated here -->
            </div>
        </section>

        <!-- History Section -->
        <section class="bg-white rounded-xl shadow-lg p-8">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-2xl font-bold text-prahari-charleston-green">Recent Scans</h3>
                <button id="refreshHistory" class="text-[#BEC9CB] hover:text-prahari-charleston-green transition-colors">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                    </svg>
                </button>
            </div>
            <div id="historyContent" class="space-y-4">
                <div class="flex items-center justify-center py-8">
                    <div class="loading-spinner mr-3"></div>
                    <p class="text-gray-500">Loading scan history...</p>
                </div>
            </div>
        </section>
    </main>

    <!-- Full Report Modal -->
    <div id="fullReportModal" class="modal fixed inset-0 bg-black bg-opacity-50 items-center justify-center z-50">
        <div class="bg-white rounded-xl shadow-2xl max-w-4xl max-h-[95vh] overflow-hidden">
            <div class="flex justify-between items-center p-6 border-b">
                <h3 class="text-2xl font-bold text-prahari-charleston-green">Detailed Analysis Report</h3>
                <button id="closeModal" class="text-gray-500 hover:text-gray-700">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>
            <div id="modalContent" class="p-6 overflow-y-auto max-h-[70vh]">
                <!-- Modal content will be populated here -->
            </div>
            <div class="p-6 border-t flex justify-end space-x-4">
                <button id="modalExportBtn" class="bg-prahari-lightred text-gray-700 px-6 py-2 rounded-lg hover:bg-opacity-80 transition-colors">
                    Download PDF
                </button>
                <button id="closeModalBtn" class="bg-gray-300 text-gray-700 px-6 py-2 rounded-lg hover:bg-gray-400 transition-colors">
                    Close
                </button>
            </div>
        </div>
    </div>

    <!-- Toast Notifications -->
    <div id="toast" class="fixed top-4 right-4 z-50 hidden">
        <div class="bg-red-500 text-white px-6 py-3 rounded-lg shadow-lg">
            <p id="toastMessage"></p>
        </div>
    </div>

    <script>
        // Global variables
        let currentScanId = null;
        let currentAnalysisResult = null;
        let isDataLoaded = false;

        // Initialize app
        document.addEventListener('DOMContentLoaded', function() {
            setupEventListeners();
            initializeData();
        });

        // Initialize data loading
        async function initializeData() {
            try {
                // Show loading spinners are already visible in HTML
                
                // Load statistics and history in parallel
                await Promise.all([
                    loadScanHistory(),
                    updateStats()
                ]);
                
                isDataLoaded = true;
                console.log('Data loaded successfully');
            } catch (error) {
                console.error('Failed to initialize data:', error);
                handleDataLoadError();
            }
        }

        // Handle data loading errors
        function handleDataLoadError() {
            // Update stats with error state
            document.getElementById('totalScans').innerHTML = '<span class="text-red-500">!</span>';
            document.getElementById('highRiskScans').innerHTML = '<span class="text-red-500">!</span>';
            document.getElementById('safeScans').innerHTML = '<span class="text-red-500">!</span>';
            
            // Update history with error state
            document.getElementById('historyContent').innerHTML = `
                <div class="text-center text-red-500 py-8">
                    <p>Failed to load scan history</p>
                    <button onclick="initializeData()" class="mt-2 text-prahari-gainsboro hover:text-prahari-charleston-green">
                        Try Again
                    </button>
                </div>
            `;
        }

        // Event listeners
        function setupEventListeners() {
            const dropZone = document.getElementById('dropZone');
            const fileInput = document.getElementById('fileInput');
            const analyzeBtn = document.getElementById('analyzeBtn');
            const removeFileBtn = document.getElementById('removeFileBtn');

            // File drop and upload
            dropZone.addEventListener('click', () => fileInput.click());
            dropZone.addEventListener('dragover', handleDragOver);
            dropZone.addEventListener('drop', handleDrop);
            fileInput.addEventListener('change', handleFileSelect);
            
            // Remove file button
            removeFileBtn.addEventListener('click', removeSelectedFile);
            
            // Analysis
            analyzeBtn.addEventListener('click', startAnalysis);
            
            // Modal controls
            document.getElementById('fullReportBtn').addEventListener('click', showFullReport);
            document.getElementById('closeModal').addEventListener('click', closeModal);
            document.getElementById('closeModalBtn').addEventListener('click', closeModal);
            
            // Export buttons
            document.getElementById('modalExportBtn').addEventListener('click', exportFullReportToPDF);
            
            // New scan button
            document.getElementById('newScanBtn').addEventListener('click', resetForNewUpload);
            
            // Refresh history
            document.getElementById('refreshHistory').addEventListener('click', () => {
                document.getElementById('historyContent').innerHTML = `
                    <div class="flex items-center justify-center py-8">
                        <div class="loading-spinner mr-3"></div>
                        <p class="text-gray-500">Refreshing scan history...</p>
                    </div>
                `;
                loadScanHistory();
            });
        }

        // File handling
        function handleDragOver(e) {
            e.preventDefault();
            e.stopPropagation();
        }

        function handleDrop(e) {
            e.preventDefault();
            e.stopPropagation();
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                handleFile(files[0]);
            }
        }

        function handleFileSelect(e) {
            const file = e.target.files[0];
            if (file) {
                handleFile(file);
            }
        }

        function handleFile(file) {
            if (!file.name.endsWith('.apk')) {
                showToast('Please select a valid APK file', 'error');
                return;
            }

            // Update file details in the selected file section
            document.getElementById('selectedFileName').textContent = file.name;
            document.getElementById('selectedFileSize').textContent = formatFileSize(file.size);
            
            // Hide drop zone and show selected file section
            document.getElementById('dropZone').classList.add('hidden');
            document.getElementById('fileSelectedSection').classList.remove('hidden');
            
            // Store file for analysis
            window.selectedFile = file;
        }

        // Remove selected file function
        function removeSelectedFile() {
            // Clear stored file
            window.selectedFile = null;
            document.getElementById('fileInput').value = '';
            
            // Hide selected file section and show drop zone
            document.getElementById('fileSelectedSection').classList.add('hidden');
            document.getElementById('dropZone').classList.remove('hidden');
        }

        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        // Analysis functions
        async function startAnalysis() {
            if (!window.selectedFile) {
                showToast('Please select a file first', 'error');
                return;
            }

            // Show progress section
            document.getElementById('uploadSection').classList.add('hidden');
            document.getElementById('progressSection').classList.remove('hidden');
            
            // Simulate progress
            const progressInterval = simulateProgress();
            
            try {
                const formData = new FormData();
                formData.append('file', window.selectedFile);
                
                const response = await fetch('/api/upload', {
                    method: 'POST',
                    body: formData
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const result = await response.json();
                currentScanId = result.scan_id;
                currentAnalysisResult = result.analysis;
                
                // Clear progress interval
                clearInterval(progressInterval);
                
                // Hide progress, show results
                setTimeout(() => {
                    document.getElementById('progressSection').classList.add('hidden');
                    displayResults(result.analysis);
                    
                    // Refresh history and stats
                    loadScanHistory();
                    updateStats();
                }, 1000);
                
            } catch (error) {
                console.error('Analysis failed:', error);
                clearInterval(progressInterval);
                showToast('Analysis failed. Please check your connection and try again.', 'error');
                document.getElementById('progressSection').classList.add('hidden');
                document.getElementById('uploadSection').classList.remove('hidden');
            }
        }

        function simulateProgress() {
            const progressBar = document.getElementById('progressBar');
            const progressText = document.getElementById('progressText');
            const steps = [
                { progress: 10, text: 'Extracting APK contents...' },
                { progress: 30, text: 'Analyzing manifest file...' },
                { progress: 50, text: 'Checking permissions...' },
                { progress: 70, text: 'Validating certificates...' },
                { progress: 85, text: 'Running ML classification...' },
                { progress: 95, text: 'Generating report...' },
                { progress: 100, text: 'Analysis complete!' }
            ];

            let currentStep = 0;
            return setInterval(() => {
                if (currentStep < steps.length) {
                    const step = steps[currentStep];
                    progressBar.style.width = step.progress + '%';
                    progressText.textContent = step.text;
                    currentStep++;
                }
            }, 800);
        }

        // Results display
        function displayResults(analysis) {
            const resultsContent = document.getElementById('resultsContent');
            const fileInfo = analysis.file_info || {};
            const apkMetadata = analysis.apk_metadata || {};
            const flags = analysis.flags || {};
            const mlResult = analysis.ml_prediction_result || {};

            const riskLevel = getRiskLevel(mlResult.confidence || 0);
            const riskColor = getRiskColor(riskLevel);

            resultsContent.innerHTML = `
                <div class="bg-prahari-aliceblue p-4 rounded-lg">
                    <h4 class="font-semibold text-prahari-charleston-green mb-2">File Information</h4>
                    <p class="text-sm"><strong>Name:</strong> ${fileInfo.file_name || 'Unknown'}</p>
                    <p class="text-sm"><strong>Hash:</strong> <span class="font-mono text-xs">${(fileInfo.file_hash || 'N/A').substring(0, 16)}...</span></p>
                </div>

                <div class="bg-prahari-aliceblue p-4 rounded-lg">
                    <h4 class="font-semibold text-prahari-charleston-green mb-2">App Details</h4>
                    <p class="text-sm"><strong>App Name:</strong> ${apkMetadata.app_name || 'Unknown'}</p>
                    <p class="text-sm"><strong>Size:</strong> ${apkMetadata.app_size_mb || 'N/A'} MB</p>
                    <p class="text-sm"><strong>Version:</strong> ${apkMetadata.app_version || 'N/A'}</p>
                </div>

                <div class="bg-prahari-aliceblue p-4 rounded-lg">
                    <h4 class="font-semibold text-prahari-charleston-green mb-2">Risk Assessment</h4>
                    <div class="tooltip-trigger relative">
                        <p class="text-sm"><strong>ML Confidence:</strong> 
                            <span class="${riskColor} font-semibold">${(mlResult.confidence * 100).toFixed(1)}%</span>
                        </p>
                        <div class="tooltip absolute bottom-full left-0 bg-prahari-charleston-green text-white p-2 rounded text-xs w-48 mb-2">
                            Machine Learning confidence score for malware detection in banking applications
                        </div>
                    </div>
                    <p class="text-sm"><strong>Risk Level:</strong> <span class="${riskColor} font-semibold">${riskLevel}</span></p>
                </div>

                <div class="bg-prahari-aliceblue p-4 rounded-lg">
                    <h4 class="font-semibold text-prahari-charleston-green mb-2">Security Flags</h4>
                    <div class="space-y-1">
                        <div class="tooltip-trigger relative">
                            <p class="text-sm">
                                <span class="inline-block w-3 h-3 rounded-full ${flags.suspicious_pkg ? 'bg-red-500' : 'bg-green-500'} mr-2"></span>
                                Package Analysis
                            </p>
                            <div class="tooltip absolute bottom-full left-0 bg-prahari-charleston-green text-white p-2 rounded text-xs w-48 mb-2">
                                Checks for suspicious package names commonly used by banking trojans
                            </div>
                        </div>
                        <div class="tooltip-trigger relative">
                            <p class="text-sm">
                                <span class="inline-block w-3 h-3 rounded-full ${flags.suspicious_permissions ? 'bg-red-500' : 'bg-green-500'} mr-2"></span>
                                Permissions Check
                            </p>
                            <div class="tooltip absolute bottom-full left-0 bg-prahari-charleston-green text-white p-2 rounded text-xs w-48 mb-2">
                                Analyzes permissions that could be used for banking fraud or data theft
                            </div>
                        </div>
                        <div class="tooltip-trigger relative">
                            <p class="text-sm">
                                <span class="inline-block w-3 h-3 rounded-full ${flags.suspicious_certificate ? 'bg-red-500' : 'bg-green-500'} mr-2"></span>
                                Certificate Validation
                            </p>
                            <div class="tooltip absolute bottom-full left-0 bg-prahari-charleston-green text-white p-2 rounded text-xs w-48 mb-2">
                                Verifies digital signature authenticity - crucial for banking app security
                            </div>
                        </div>
                    </div>
                </div>

                <div class="bg-prahari-aliceblue p-4 rounded-lg">
                    <h4 class="font-semibold text-prahari-charleston-green mb-2">Analysis Time</h4>
                    <p class="text-sm">${new Date(analysis.analysis_timestamp).toLocaleString()}</p>
                </div>
            `;

            document.getElementById('resultsSection').classList.remove('hidden');
        }

        function getRiskLevel(confidence) {
            if (confidence > 0.7) return 'High Risk';
            if (confidence > 0.4) return 'Medium Risk';
            return 'Low Risk';
        }

        function getRiskColor(riskLevel) {
            switch(riskLevel) {
                case 'High Risk': return 'risk-high';
                case 'Medium Risk': return 'risk-medium';
                default: return 'risk-low';
            }
        }

        // History functions
        async function loadScanHistory() {
            try {
                const response = await fetch('/api/scans');
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const scans = await response.json();
                displayHistory(scans.slice(0, 10)); // Show only recent 10 in UI
                
            } catch (error) {
                console.error('Failed to load history:', error);
                displayHistory([]); // Show empty state
            }
        }

        function displayHistory(scans) {
            const historyContent = document.getElementById('historyContent');
            
            if (scans.length === 0) {
                historyContent.innerHTML = '<p class="text-center text-gray-500 py-8">No scan history available</p>';
                return;
            }

            historyContent.innerHTML = scans.map(scan => {
                const fileInfo = scan.file_info || {};
                const apkMetadata = scan.apk_metadata || {};
                const mlResult = scan.ml_prediction_result || {};
                const riskLevel = getRiskLevel(mlResult.confidence || 0);
                const riskColor = getRiskColor(riskLevel);

                return `
                    <div class="flex items-center justify-between p-4 border border-gray-200 rounded-lg hover:bg-prahari-antiflashwhite transition-colors">
                        <div class="flex-1">
                            <h4 class="font-semibold text-prahari-charleston-green">${apkMetadata.app_name || fileInfo.file_name || 'Unknown App'}</h4>
                            <div class="flex items-center space-x-4 mt-2 text-sm text-gray-600">
                                <span>Risk: <span class="${riskColor} font-semibold">${riskLevel}</span></span>
                                <span>Confidence: ${(mlResult.confidence * 100).toFixed(1)}%</span>
                                <span>${new Date(scan.analysis_timestamp).toLocaleDateString()}</span>
                            </div>
                        </div>
                        <button onclick="showHistoryReport(${scan.id})" class="bg-prahari-gainsboro text-prahari-charleston-green px-4 py-2 rounded-lg hover:bg-[#BEC9CB] transition-colors">
                            View Report
                        </button>
                    </div>
                `;
            }).join('');
        }

        async function showHistoryReport(scanId) {
            try {
                const response = await fetch(`/api/scan/${scanId}`);
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const scanData = await response.json();
                
                currentScanId = scanId;
                currentAnalysisResult = scanData;
                showFullReport();
                
            } catch (error) {
                console.error('Failed to load scan report:', error);
                showToast('Failed to load scan report', 'error');
            }
        }

        // Statistics functions
        async function updateStats() {
            try {
                const response = await fetch('/api/scans');
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const allScans = await response.json(); // Get ALL scans for statistics
                
                const totalScans = allScans.length;
                let highRiskScans = 0;
                let safeScans = 0;

                // Calculate statistics from ALL scans, not just the first 10
                allScans.forEach(scan => {
                    const mlResult = scan.ml_prediction_result || {};
                    const confidence = mlResult.confidence || 0;
                    
                    if (confidence > 0.7) {
                        highRiskScans++;
                    } else if (confidence <= 0.4) {
                        safeScans++;
                    }
                });

                // Animate the counters
                animateCounter('totalScans', totalScans);
                animateCounter('highRiskScans', highRiskScans);
                animateCounter('safeScans', safeScans);
                
            } catch (error) {
                console.error('Failed to update stats:', error);
                // Show error state
                document.getElementById('totalScans').innerHTML = '<span class="text-red-500 text-sm">Error</span>';
                document.getElementById('highRiskScans').innerHTML = '<span class="text-red-500 text-sm">Error</span>';
                document.getElementById('safeScans').innerHTML = '<span class="text-red-500 text-sm">Error</span>';
            }
        }

        function animateCounter(elementId, targetValue) {
            const element = document.getElementById(elementId);
            const startValue = 0;
            const duration = 1000;
            const startTime = performance.now();

            function updateCounter(currentTime) {
                const elapsed = currentTime - startTime;
                const progress = Math.min(elapsed / duration, 1);
                const currentValue = Math.floor(startValue + (targetValue - startValue) * progress);
                
                element.textContent = currentValue;
                
                if (progress < 1) {
                    requestAnimationFrame(updateCounter);
                }
            }
            
            requestAnimationFrame(updateCounter);
        }

        // Modal functions
        function showFullReport() {
            if (!currentAnalysisResult) {
                showToast('No analysis data available', 'error');
                return;
            }

            const modalContent = document.getElementById('modalContent');
            const analysis = currentAnalysisResult;
            
            modalContent.innerHTML = generateFullReportHTML(analysis);
            document.getElementById('fullReportModal').classList.add('active');
        }

        function closeModal() {
            document.getElementById('fullReportModal').classList.remove('active');
        }

        function generateFullReportHTML(analysis) {
            const fileInfo = analysis.file_info || {};
            const apkMetadata = analysis.apk_metadata || {};
            const certInfo = analysis.certificate_info || {};
            const permissions = analysis.permissions || {};
            const flags = analysis.flags || {};
            const mlResult = analysis.ml_prediction_result || {};

            return `
                <div class="space-y-6">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="col-span-2">
                            <div class="bg-prahari-aliceblue p-4 rounded-lg">
                                <h4 class="font-bold text-prahari-charleston-green mb-3">File Information</h4>
                                <div class="space-y-2 text-sm">
                                    <p><strong>File Name:</strong> ${fileInfo.file_name || 'N/A'}</p>
                                    <p><strong>File Hash:</strong> <span class="font-mono text-xs">${fileInfo.file_hash || 'N/A'}</span></p>
                                    <p><strong>Analysis Time:</strong> ${new Date(analysis.analysis_timestamp).toLocaleString()}</p>
                                </div>
                            </div>
                        </div>

                        <div class="bg-prahari-aliceblue p-4 rounded-lg">
                            <h4 class="font-bold text-prahari-charleston-green mb-3">APK Metadata</h4>
                            <div class="space-y-2 text-sm">
                                <p><strong>App Name:</strong> ${apkMetadata.app_name || 'N/A'}</p>
                                <p><strong>Package Name:</strong> ${apkMetadata.package_name || 'N/A'}</p>
                                <p><strong>Version:</strong> ${apkMetadata.app_version || 'N/A'}</p>
                                <p><strong>Size:</strong> ${apkMetadata.app_size_mb || 'N/A'} MB</p>
                                <p><strong>Target SDK:</strong> ${apkMetadata.target_sdk || 'N/A'}</p>
                            </div>
                        </div>

                        <div class="bg-prahari-aliceblue p-4 rounded-lg">
                            <h4 class="font-bold text-prahari-charleston-green mb-3">Security Flags</h4>
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 text-sm">
                                <div>
                                    <p class="font-semibold">Suspicious Package</p>
                                    <p class="${flags.suspicious_pkg ? 'text-red-600' : 'text-green-600'}">${flags.suspicious_pkg ? 'Yes' : 'No'}</p>
                                </div>
                                <div>
                                    <p class="font-semibold">Suspicious Permissions</p>
                                    <p class="${flags.suspicious_permissions ? 'text-red-600' : 'text-green-600'}">${flags.suspicious_permissions ? 'Yes' : 'No'}</p>
                                </div>
                                <div>
                                    <p class="font-semibold">Suspicious Certificate</p>
                                    <p class="${flags.suspicious_certificate ? 'text-red-600' : 'text-green-600'}">${flags.suspicious_certificate ? 'Yes' : 'No'}</p>
                                </div>
                            </div>
                        </div>

                    </div>

                    <div class="bg-prahari-aliceblue p-4 rounded-lg">
                        <h4 class="font-bold text-prahari-charleston-green mb-3">Permissions Analysis</h4>
                        <div class="max-h-32 overflow-y-auto">
                            <div class="text-sm space-y-1">
                                ${Object.keys(permissions).length > 0 ? 
                                    Object.entries(permissions).map(([perm, value]) => 
                                        `<p><strong>${perm}:</strong> ${value}</p>`
                                    ).join('') : 
                                    '<p>No permission data available</p>'
                                }
                            </div>
                        </div>
                    </div>

                    <div class="bg-prahari-aliceblue p-4 rounded-lg">
                        <h4 class="font-bold text-prahari-charleston-green mb-3">Certificate Information</h4>
                        <div class="text-sm space-y-2">
                            ${Object.keys(certInfo).length > 0 ? 
                                Object.entries(certInfo).map(([key, value]) => 
                                    `<p><strong>${key.replace(/_/g, ' ').toUpperCase()}:</strong> ${value}</p>`
                                ).join('') : 
                                '<p>No certificate data available</p>'
                            }
                        </div>
                    </div>

                    <div class="bg-prahari-aliceblue p-4 rounded-lg">
                        <h4 class="font-bold text-prahari-charleston-green mb-3">ML Prediction Results</h4>
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-sm">
                            <div>
                                <p class="font-semibold">Overall Confidence</p>
                                <p class="${getRiskColor(getRiskLevel(mlResult.confidence || 0))}">${(mlResult.confidence * 100).toFixed(2)}%</p>
                            </div>
                            <div>
                                <p class="font-semibold">Package Score</p>
                                <p>${(mlResult.pkg_confidence * 100).toFixed(2)}%</p>
                            </div>
                            <div>
                                <p class="font-semibold">Permission Score</p>
                                <p>${(mlResult.perm_confidence * 100).toFixed(2)}%</p>
                            </div>
                            <div>
                                <p class="font-semibold">Certificate Score</p>
                                <p>${(mlResult.cert_confidence * 100).toFixed(2)}%</p>
                            </div>
                        </div>
                    </div>

                </div>
            `;
        }

        // Export functions
        function exportFullReportToPDF() {
            if (!currentAnalysisResult) {
                showToast('No analysis data to export', 'error');
                return;
            }
            
            generatePDF(currentAnalysisResult, true);
        }


        // PDF gen
        function generatePDF(analysis, isFullReport) {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();

            // Brand Colors
            const COLORS = {
                charleston: '#1E2A2F',
                gainsboro: '#D7DEDF',
                antiflash: '#F4F2F1',
                lightred: '#FFCCCF',
                brightgrey: '#EAEFF4',
                aliceblue: '#F2F7FA'
            };

            // Page setup
            const pageWidth = doc.internal.pageSize.getWidth();
            const pageHeight = doc.internal.pageSize.getHeight();
            const margin = { l: 20, r: 20, t: 25, b: 25 };
            let y = margin.t;

            // Data
            const fileInfo = analysis.file_info || {};
            const apkMetadata = analysis.apk_metadata || {};
            const certInfo = analysis.certificate_info || {};
            const permissions = analysis.permissions || {};
            const flags = analysis.flags || {};
            const mlResult = analysis.ml_prediction_result || {};

            // Helpers
            const addFooter = () => {
                const footerY = pageHeight - 12;
                doc.setFillColor(COLORS.gainsboro);
                doc.rect(0, footerY - 6, pageWidth, 18, 'F');

                doc.setTextColor(COLORS.charleston);
                doc.setFont('helvetica', 'normal');
                doc.setFontSize(8);
                doc.text('Generated by Prahari APK Security Scanner', margin.l, footerY);
                doc.text(`Page ${doc.internal.getCurrentPageInfo().pageNumber}`, pageWidth - margin.r - 20, footerY);
            };

            const checkPageBreak = (neededHeight = 10) => {
                if (y + neededHeight > pageHeight - margin.b) {
                    addFooter();
                    doc.addPage();
                    addHeader();
                    y = margin.t + 30;
                }
            };

            const addHeader = () => {
                // Header background
                doc.setFillColor(COLORS.charleston);
                doc.rect(0, 0, pageWidth, 45, 'F');

                // Logo simulation
                doc.setFillColor(COLORS.gainsboro);
                doc.roundedRect(margin.l, 12, 12, 12, 2, 2, 'F');
                doc.setTextColor(COLORS.charleston);
                doc.setFontSize(8);
                doc.text('âœ“', margin.l + 4.5, 20);

                // Title
                doc.setTextColor(255, 255, 255);
                doc.setFont('helvetica', 'bold');
                doc.setFontSize(18);
                doc.text('Prahari: APK Security Report', margin.l + 18, 22);

                doc.setFont('helvetica', 'normal');
                doc.setFontSize(9);
                doc.text('Safeguarding Banking Applications', margin.l + 18, 32);

                // Right-aligned info
                const reportDate = new Date().toLocaleDateString('en-US', {
                    year: 'numeric', month: 'long', day: 'numeric'
                });
                doc.setFontSize(8);
                doc.text(`Generated: ${reportDate}`, pageWidth - margin.r - 60, 22);
                doc.text(isFullReport ? 'Full Analysis Report' : 'Summary Report', pageWidth - margin.r - 60, 30);

                y = 55;
            };

            const sectionHeader = (title, color = COLORS.charleston) => {
                checkPageBreak(20);
                doc.setFillColor(COLORS.aliceblue);
                doc.rect(margin.l - 2, y, pageWidth - margin.l - margin.r + 4, 14, 'F');

                doc.setTextColor(color);
                doc.setFont('helvetica', 'bold');
                doc.setFontSize(12);
                doc.text(title, margin.l + 2, y + 10);

                y += 20;
            };

            const dataRow = (label, value) => {
                checkPageBreak(12);
                doc.setTextColor(COLORS.charleston);
                doc.setFont('helvetica', 'bold');
                doc.setFontSize(9);
                doc.text(label + ':', margin.l + 4, y);

                // Wrap value text if long
                doc.setFont('helvetica', 'normal');
                doc.setTextColor(60, 60, 60);
                const text = doc.splitTextToSize(String(value || 'N/A'), pageWidth - margin.l - margin.r - 60);
                doc.text(text, margin.l + 70, y);

                y += text.length * 5 + 2;
            };

            const flagIndicator = (label, isPositive) => {
                checkPageBreak(10);
                const circleColor = isPositive ? '#EF4444' : '#10B981';
                doc.setFillColor(circleColor);
                doc.circle(margin.l + 6, y - 2, 2, 'F');

                doc.setTextColor(COLORS.charleston);
                doc.setFontSize(9);
                doc.text(label, margin.l + 14, y);

                doc.setFont('helvetica', 'bold');
                doc.setTextColor(circleColor);
                doc.text(isPositive ? 'DETECTED' : 'CLEAR', pageWidth - margin.r - 60, y);

                y += 8;
            };

            // Risk calculation
            const getRiskLevel = (c) => c > 0.7 ? 'High' : c > 0.4 ? 'Medium' : 'Low';

            // === Build PDF ===
            addHeader();

            // Executive summary
            const confidence = Number(mlResult.confidence || 0);
            const riskLevel = getRiskLevel(confidence);

            doc.setFillColor(COLORS.brightgrey);
            doc.roundedRect(margin.l, y, pageWidth - margin.l - margin.r, 30, 3, 3, 'F');

            doc.setTextColor(COLORS.charleston);
            doc.setFont('helvetica', 'bold');
            doc.setFontSize(11);
            doc.text('EXECUTIVE SUMMARY', margin.l + 8, y + 10);

            doc.setFont('helvetica', 'normal');
            doc.setFontSize(9);
            doc.text(`App: ${apkMetadata.app_name || fileInfo.file_name || 'Unknown'}`, margin.l + 8, y + 18);
            doc.text(`ML Confidence: ${(confidence * 100).toFixed(1)}%`, margin.l + 8, y + 25);

            doc.setFont('helvetica', 'bold');
            const riskColor = confidence > 0.7 ? '#DC2626' : confidence > 0.4 ? '#F59E0B' : '#059669';
            doc.setTextColor(riskColor);
            doc.text(`Risk: ${riskLevel}`, pageWidth - margin.r - 50, y + 18);

            y += 45;

            // File Information
            sectionHeader('FILE INFORMATION');
            dataRow('File Name', fileInfo.file_name);
            dataRow('File Hash', fileInfo.file_hash);
            dataRow('File Size', apkMetadata.app_size_mb ? `${apkMetadata.app_size_mb} MB` : 'N/A');
            dataRow('Analysis Time', analysis.analysis_timestamp ? new Date(analysis.analysis_timestamp).toLocaleString() : 'N/A');

            // Application Details
            sectionHeader('APPLICATION DETAILS');
            dataRow('Application Name', apkMetadata.app_name);
            dataRow('Package Name', apkMetadata.package_name);
            dataRow('Version', apkMetadata.app_version);
            dataRow('Target SDK', apkMetadata.target_sdk);

            // Security Assessment
            sectionHeader('SECURITY ASSESSMENT');
            dataRow('Overall Risk Level', riskLevel);
            dataRow('ML Confidence Score', `${(confidence * 100).toFixed(1)}%`);

            // Security Flags
            sectionHeader('SECURITY FLAGS');
            flagIndicator('Suspicious Package Names', flags.suspicious_pkg);
            flagIndicator('Dangerous Permissions', flags.suspicious_permissions);
            flagIndicator('Invalid Certificate', flags.suspicious_certificate);

            // Extra sections if full
            if (isFullReport) {
                sectionHeader('MACHINE LEARNING ANALYSIS');
                dataRow('Package Score', mlResult.pkg_confidence ? `${(mlResult.pkg_confidence * 100).toFixed(2)}%` : 'N/A');
                dataRow('Permissions Score', mlResult.perm_confidence ? `${(mlResult.perm_confidence * 100).toFixed(2)}%` : 'N/A');
                dataRow('Certificate Score', mlResult.cert_confidence ? `${(mlResult.cert_confidence * 100).toFixed(2)}%` : 'N/A');

                if (Object.keys(permissions).length > 0) {
                    sectionHeader('PERMISSIONS ANALYSIS');
                    Object.keys(permissions).slice(0, 15).forEach(p => {
                        checkPageBreak(6);
                        doc.setFont('helvetica', 'normal');
                        doc.setFontSize(8);
                        doc.text(`â€¢ ${p}`, margin.l + 4, y);
                        y += 5;
                    });
                    if (Object.keys(permissions).length > 15) {
                        doc.setFont('helvetica', 'italic');
                        doc.text(`...and ${Object.keys(permissions).length - 15} more`, margin.l + 4, y);
                        y += 5;
                    }
                }

                if (Object.keys(certInfo).length > 0) {
                    sectionHeader('CERTIFICATE INFORMATION');
                    Object.entries(certInfo).forEach(([k, v]) => {
                        dataRow(k.replace(/_/g, ' ').toUpperCase(), v);
                    });
                }
            }

            // Final footer
            addFooter();

            const fileName = `prahari_${isFullReport ? 'full' : 'summary'}_report_${fileInfo.file_name || 'scan'}_${Date.now()}.pdf`;
            doc.save(fileName);

            showToast('Professional PDF report generated successfully', 'success');
        }


        // Reset function for new upload
        function resetForNewUpload() {
            document.getElementById('uploadSection').classList.remove('hidden');
            document.getElementById('resultsSection').classList.add('hidden');
            document.getElementById('progressSection').classList.add('hidden');
            
            // Reset file selection UI
            removeSelectedFile();
            
            currentScanId = null;
            currentAnalysisResult = null;
        }

        // Utility functions
        function showToast(message, type = 'error') {
            const toast = document.getElementById('toast');
            const toastMessage = document.getElementById('toastMessage');
            
            toastMessage.textContent = message;
            
            // Set color based on type
            const toastDiv = toast.querySelector('div');
            if (type === 'success') {
                toastDiv.className = 'bg-green-500 text-white px-6 py-3 rounded-lg shadow-lg';
            } else {
                toastDiv.className = 'bg-red-500 text-white px-6 py-3 rounded-lg shadow-lg';
            }
            
            toast.classList.remove('hidden');
            
            setTimeout(() => {
                toast.classList.add('hidden');
            }, 3000);
        }
    </script>
</body>
</html>